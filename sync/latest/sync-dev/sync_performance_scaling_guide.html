<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta content="IE=edge" http-equiv="X-UA-Compatible">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>aerogear Latest | Sync User Guide | Performance guide</title>

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">

    <link href="../../latest/_stylesheets/asciibinder.css" rel="stylesheet" />

   <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
   <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
   <!--[if lt IE 9]>
     <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
     <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
   <![endif]-->

  <link href="../../latest/_images/favicon32x32.png" rel="shortcut icon" type="text/css">
  <!--[if IE]><link rel="shortcut icon" href="../../latest/_images/favicon.ico"><![endif]-->
  <meta content="Red Hat" name="application-name">
</head>
<body>
  <div class="navbar navbar-default" role="navigation">
    <div class="container-fluid">
      <div class="navbar-header">
        <a class="navbar-brand" href="https://aerogear.org/"><img alt="Build Farm" src="../../latest/_images/aerogear_logo_200px.png"></a>
      </div>
    </div>
  </div>
  <div class="container">
    <p class="toggle-nav visible-xs pull-left">
      <button class="btn btn-default btn-sm" type="button" data-toggle="offcanvas">Toggle nav</button>
    </p>
    <ol class="breadcrumb">
      <li class="sitename">
        <a href="../../index.html">AeroGear</a>
      </li>
      <li class="hidden-xs active">
        <a href="../sync-dev/sync_overview.html">aerogear Latest</a>
      </li>
      <li class="hidden-xs active">
        <a href="../sync-dev/sync_overview.html">Sync User Guide</a>
      </li>
      
      <li class="hidden-xs active">
        Performance guide
      </li>
    </ol>
    <div class="row row-offcanvas row-offcanvas-left">
      <div class="col-xs-8 col-sm-3 col-md-3 sidebar sidebar-offcanvas">
        <ul class="nav nav-sidebar">
    <li class="nav-header">
      <a class="" href="#" data-toggle="collapse" data-target="#topicGroup0">
        <span id="tgSpan0" class="fa fa-angle-down"></span>Sync User Guide
      </a>
      <ul id="topicGroup0" class="collapse in list-unstyled">
            <li><a class="" href="../sync-dev/sync_overview.html">Overview</a></li>
            <li><a class="" href="../sync-dev/sync_terminology.html">Terminology</a></li>
            <li><a class="" href="../sync-dev/sync_server_architecture.html">Server architecture</a></li>
            <li><a class="" href="../sync-dev/sync_configuration_guide.html">Configuration guide</a></li>
            <li><a class="" href="../sync-dev/sync_upgrade_guide.html">Upgrade guide</a></li>
            <li><a class=" active" href="../sync-dev/sync_performance_scaling_guide.html">Performance guide</a></li>
            <li><a class="" href="../sync-dev/sync_collections.html">Collections</a></li>
            <li><a class="" href="../sync-dev/sync_debugging_guide.html">Debugging guide</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="#" data-toggle="collapse" data-target="#topicGroup1">
        <span id="tgSpan1" class="fa fa-angle-right"></span>Sync API Guide
      </a>
      <ul id="topicGroup1" class="collapse  list-unstyled">
            <li><a class="" href="../sync-ref/sync.html">sync</a></li>
            <li><a class="" href="../sync-ref/sync-connect.html">connect</a></li>
            <li><a class="" href="../sync-ref/sync-geteventemitter.html">geteventemitter</a></li>
            <li><a class="" href="../sync-ref/sync-globalhandlecollision.html">globalhandlecollision</a></li>
            <li><a class="" href="../sync-ref/sync-globalhandlecreate.html">globalhandlecreate</a></li>
            <li><a class="" href="../sync-ref/sync-globalhandledelete.html">globalhandledelete</a></li>
            <li><a class="" href="../sync-ref/sync-globalhandlelist.html">globalhandlelist</a></li>
            <li><a class="" href="../sync-ref/sync-globalhandleread.html">globalhandleread</a></li>
            <li><a class="" href="../sync-ref/sync-globalhandleupdate.html">globalhandleupdate</a></li>
            <li><a class="" href="../sync-ref/sync-globalinterceptrequest.html">globalinterceptrequest</a></li>
            <li><a class="" href="../sync-ref/sync-globallistcollisions.html">globallistcollisions</a></li>
            <li><a class="" href="../sync-ref/sync-globalremovecollision.html">globalremovecollision</a></li>
            <li><a class="" href="../sync-ref/sync-handlecollision.html">handlecollision</a></li>
            <li><a class="" href="../sync-ref/sync-handlecreate.html">handlecreate</a></li>
            <li><a class="" href="../sync-ref/sync-handledelete.html">handledelete</a></li>
            <li><a class="" href="../sync-ref/sync-handlelist.html">handlelist</a></li>
            <li><a class="" href="../sync-ref/sync-handleread.html">handleread</a></li>
            <li><a class="" href="../sync-ref/sync-handleupdate.html">handleupdate</a></li>
            <li><a class="" href="../sync-ref/sync-init.html">init</a></li>
            <li><a class="" href="../sync-ref/sync-interceptrequest.html">interceptrequest</a></li>
            <li><a class="" href="../sync-ref/sync-invoke.html">invoke</a></li>
            <li><a class="" href="../sync-ref/sync-listcollisions.html">listcollisions</a></li>
            <li><a class="" href="../sync-ref/sync-removecollision.html">removecollision</a></li>
            <li><a class="" href="../sync-ref/sync-setconfig.html">setconfig</a></li>
            <li><a class="" href="../sync-ref/sync-setglobalhashfn.html">setglobalhashfn</a></li>
            <li><a class="" href="../sync-ref/sync-setrecordhashfn.html">setrecordhashfn</a></li>
            <li><a class="" href="../sync-ref/sync-stop.html">stop</a></li>
            <li><a class="" href="../sync-ref/sync-stopall.html">stopall</a></li>
            <li><a class="" href="../sync-ref/sync-toc.html">toc</a></li>
      </ul>
    </li>
</ul>
      </div>
      <div class="col-xs-12 col-sm-9 col-md-9 main">
        <div class="page-header">
          <h2>Sync Server Performance and Scaling</h2>
        </div>
        <div class="sect1">
<h2 id="overview"><a class="anchor" href="#overview"></a>Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The sync server is designed to be scalable.</p>
</div>
<div class="paragraph">
<p>This section helps you understand the performance of the sync server, and the options for scaling.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you are using a 1 CPU core with the sync server included with <code>fh-mbaas-api</code> version 7.0.0 or later, the performance could decrease compared to previous versions with default configurations. To improve performance of the sync server on a single core, consider adjusting the configuration as described in the <a href="#sync_configuration_guide">[sync_configuration_guide]</a>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="inspecting-performance"><a class="anchor" href="#inspecting-performance"></a>Inspecting Performance</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are 2 options to inspect the performance of the sync server:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Query the <code>/mbaas/sync/stats</code> endpoint.</p>
<div class="paragraph">
<p>By default, the Sync framework saves metrics data into Redis while it is running.
You can then send a HTTP GET request to the <code>/mbaas/sync/stats</code> endpoint to view the summary of those metrics data.</p>
</div>
<div class="paragraph">
<p>The following information is available from this endpoint:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>CPU and Memory Usage of all the workers</p>
</li>
<li>
<p>The time taken to process various jobs</p>
</li>
<li>
<p>The number of the remaining jobs in various job queues</p>
</li>
<li>
<p>The time taken for various API calls</p>
</li>
<li>
<p>The time taken for various MongoDB operations</p>
<div class="paragraph">
<p>For each of those metrics, you are able to see the total number of samples, the current, maximum, minimum and average values.</p>
</div>
<div class="paragraph">
<p>By default, it collects the last 1000 samples for each metric, but you can control that using the <code>statsRecordsToKeep</code> configuration option.</p>
</div>
<div class="paragraph">
<p>This endpoint is easy to use and provides enough information for you to understand the current performance of the sync server.</p>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Visualize the metrics data with InfluxDB and Grafana</p>
<div class="paragraph">
<p>If you want to visualize the current and historical metrics data, you can instruct the sync server to send the metrics data to InfluxDB, and view the graphs in Grafana.</p>
</div>
<div class="paragraph">
<p>There are plenty of tutorials online to help setup InfluxDB and Grafana. For example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/feedhenry/sync-metrics-openshift">How to setup InfluxDB and Grafana on OpenShift</a></p>
<div class="paragraph">
<p>Once you have InfluxDB running, you just need to update the following configurations to instruct the sync server to send metrics data:</p>
</div>
</li>
<li>
<p>metricsInfluxdbHost</p>
</li>
<li>
<p>metricsInfluxdbPort</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Make sure <code>metricsInfluxdbPort</code> is a UDP port</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To see the metrics data graph in Grafana, you need to create a new dashboard with graphs.
The quickest way is to import <a href="https://github.com/feedhenry/sync-metrics-openshift/blob/master/dashboards/sync-stats.json">this Grafana databoard file</a>.
Once the app is running, you can view metrics data in the Grafana dashboard.</p>
</div>
<div class="paragraph">
<p>For more details about how to configure the Grafana graphs, please refer to the <a href="http://docs.grafana.org/">Grafana Documentation</a>.</p>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="understanding-performance"><a class="anchor" href="#understanding-performance"></a>Understanding Performance</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To understand the performance of the sync server, here are some of the key metrics you need to look at:</p>
</div>
<div class="sect2">
<h3 id="cpu-usage"><a class="anchor" href="#cpu-usage"></a>CPU Usage</h3>
<div class="paragraph">
<p>This is the most important metric.
On one hand, if CPU is over loaded, then the sync server cannot respond to the client requests.
On the other hand, we want to utilize the CPU usage as much as possible.</p>
</div>
<div class="paragraph">
<p>To balance that, establish a threshold to determine when to scale the sync server. The recommended value is 80%.</p>
</div>
<div class="paragraph">
<p>If CPU utilization is below that, it is not necessary to scale the sync server, and you can probably reduce a few worker interval configurations to increase the CPU usages.
However, if CPU usage is above that threshold, consider the following adjustments to improve performance:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Scaling the sync server</p>
</li>
<li>
<p>Increase some of the worker intervals to reduce the load on CPU as described in <a href="#configuring_the_workers">[configuring_the_workers]</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="remaining-jobs-in-queues"><a class="anchor" href="#remaining-jobs-in-queues"></a>Remaining Jobs in Queues</h3>
<div class="paragraph">
<p>The sync server saves various jobs in queues to process them later.</p>
</div>
<div class="paragraph">
<p>If the number of jobs in queues keeps growing, and the CPU utilization is relatively low, reduce worker interval configurations to process the jobs quicker.</p>
</div>
<div class="paragraph">
<p>If the sync server is already under heavy load, consider scaling the sync server to allow new workers to be created to process the jobs.</p>
</div>
</div>
<div class="sect2">
<h3 id="api-response-time"><a class="anchor" href="#api-response-time"></a>API response time</h3>
<div class="paragraph">
<p>If you observe increases in the response time for various sync APIs, and the CPU usage is going up, it means the sync server is under load, consider scaling the sync server.</p>
</div>
<div class="paragraph">
<p>However, if the CPU usage does not change much, that typically means something else is causing the slow down, and you need to investigate the problem.</p>
</div>
</div>
<div class="sect2">
<h3 id="mongodb-operation-time"><a class="anchor" href="#mongodb-operation-time"></a>MongoDB operation time</h3>
<div class="paragraph">
<p>In a production environment, the time for various MongoDB operations should be relatively low and consistent.
If you start observing increases of time for those operations, it could mean the sync server is generating too many operations on the MongoDB and starts to reach the limit of MongoDB.</p>
</div>
<div class="paragraph">
<p>In this case, scaling the sync server does not help, because the bottleneck is in MongoDB. There are a few options you can consider:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Turn on caching by setting the <code>useCache</code> flag to true. This reduces the number of database requests to read dataset records.</p>
</li>
<li>
<p>Increase the various worker intervals and sync frequencies.</p>
</li>
<li>
<p>If possible, scale MongoDB.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="scaling-the-sync-server"><a class="anchor" href="#scaling-the-sync-server"></a>Scaling the Sync Server</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you decide to scale the sync server, here are some of the options you can consider:</p>
</div>
<div class="sect2">
<h3 id="scaling-on-an-hosted-mbaas"><a class="anchor" href="#scaling-on-an-hosted-mbaas"></a>Scaling on an Hosted MBaaS</h3>
<div class="paragraph">
<p>There are 2 options to scale the sync server on the RHAMP SaaS platform:</p>
</div>
<div class="sect3">
<h4 id="use-the-node-js-cluster-module"><a class="anchor" href="#use-the-node-js-cluster-module"></a>Use the Node.js Cluster Module</h4>
<div class="paragraph">
<p>To scale inside a single app, you can use <a href="https://nodejs.org/docs/latest-v4.x/api/cluster.html">Nodejs Clustering</a> to create more workers.</p>
</div>
</div>
<div class="sect3">
<h4 id="deploy-more-apps"><a class="anchor" href="#deploy-more-apps"></a>Deploy More Apps</h4>
<div class="paragraph">
<p>Another option is to deploy more apps but point them to the same MongoDB as the existing app.
This allows you to scale the sync server even further.</p>
</div>
<div class="paragraph">
<p>To deploy more apps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Deploy a few more apps with the same code as the existing app.</p>
</li>
<li>
<p>Find out the MongoDB connection string of the existing app.</p>
<div class="paragraph">
<p>It is listed on the <strong>Environment Varaible</strong> screen in the App Studio, look for a System Environment Variable called <em>FH_MONGODB_CONN_URL</em></p>
</div>
</li>
<li>
<p>Copy the value, and create a new environment variable called <em>SYNC_MONGODB_URL</em> in the newly created apps, and paste the MongoDB url as the value.</p>
</li>
<li>
<p>Redeploy the apps.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>With this approach, you can separate the HTTP request handling and sync data processing completely.</p>
</div>
<div class="paragraph">
<p>For example, if there are 2 apps setup like this, App 1 and App 2, and App 1 is the cloud app that accepts HTTP requests.
You can then:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Set the worker concurrencies to 0 to disable all the sync workers in App 1. It is then dedicated to handle HTTP requests.</p>
</li>
<li>
<p>Increase the concurrencies of sync workers in App 2, and reduce the sync interval values.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Please check <a href="{CloudAPI}#fh-set-config">$fh.sync.setConfig</a> for more information about how to configure the worker concurrencies.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="scaling-on-self-managed-mbaas"><a class="anchor" href="#scaling-on-self-managed-mbaas"></a>Scaling on Self-managed MBaaS</h3>
<div class="paragraph">
<p>Use the auto scaling feature to scale the application on OpenShift.</p>
</div>
<div class="paragraph">
<p>Make sure metrics is enabled on the OpenShift cluster, and then use the <code>oc autoscale</code> command to configure how the application is scaled.</p>
</div>
<div class="paragraph">
<p>For example, on OpenShift 3.2, see how to <a href="https://docs.openshift.com/enterprise/3.2/install_config/cluster_metrics.html#metrics-deployer">enable cluster metrics</a> and  how to <a href="https://docs.openshift.com/enterprise/3.2/dev_guide/pod_autoscaling.html#dev-guide-pod-autoscaling">scale the application</a>.</p>
</div>
</div>
</div>
</div>
      </div>
    </div>
  </div>
   <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
   <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
   <!-- Latest compiled and minified JavaScript -->
   <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
   <script src="../../latest/_javascripts/bootstrap-offcanvas.js" type="text/javascript"></script>
   <script type="text/javascript">
    /*<![CDATA[*/
    $(document).ready(function() {
      $("[id^='topicGroup']").on('show.bs.collapse', function (event) {
        if (!($(event.target).attr('id').match(/^topicSubGroup/))) {
          $(this).parent().find("[id^='tgSpan']").toggleClass("fa-angle-right fa-angle-down");
        }
      });
      $("[id^='topicGroup']").on('hide.bs.collapse', function (event) {
        if (!($(event.target).attr('id').match(/^topicSubGroup/))) {
          $(this).parent().find("[id^='tgSpan']").toggleClass("fa-angle-right fa-angle-down");
        }
      });
      $("[id^='topicSubGroup']").on('show.bs.collapse', function () {
        $(this).parent().find("[id^='sgSpan']").toggleClass("fa-caret-right fa-caret-down");
      });
      $("[id^='topicSubGroup']").on('hide.bs.collapse', function () {
        $(this).parent().find("[id^='sgSpan']").toggleClass("fa-caret-right fa-caret-down");
      });
    });
    /*]]>*/
  </script>
</body>
</html>