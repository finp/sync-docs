<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta content="IE=edge" http-equiv="X-UA-Compatible">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>aerogear Latest | Sync User Guide | Debugging guide</title>

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">

    <link href="../../latest/_stylesheets/asciibinder.css" rel="stylesheet" />

   <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
   <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
   <!--[if lt IE 9]>
     <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
     <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
   <![endif]-->

  <link href="../../latest/_images/favicon32x32.png" rel="shortcut icon" type="text/css">
  <!--[if IE]><link rel="shortcut icon" href="../../latest/_images/favicon.ico"><![endif]-->
  <meta content="Red Hat" name="application-name">
</head>
<body>
  <div class="navbar navbar-default" role="navigation">
    <div class="container-fluid">
      <div class="navbar-header">
        <a class="navbar-brand" href="https://aerogear.org/"><img alt="Build Farm" src="../../latest/_images/aerogear_logo_200px.png"></a>
      </div>
    </div>
  </div>
  <div class="container">
    <p class="toggle-nav visible-xs pull-left">
      <button class="btn btn-default btn-sm" type="button" data-toggle="offcanvas">Toggle nav</button>
    </p>
    <ol class="breadcrumb">
      <li class="sitename">
        <a href="../../index.html">AeroGear</a>
      </li>
      <li class="hidden-xs active">
        <a href="../sync-dev/sync_overview.html">aerogear Latest</a>
      </li>
      <li class="hidden-xs active">
        <a href="../sync-dev/sync_overview.html">Sync User Guide</a>
      </li>
      
      <li class="hidden-xs active">
        Debugging guide
      </li>
    </ol>
    <div class="row row-offcanvas row-offcanvas-left">
      <div class="col-xs-8 col-sm-3 col-md-3 sidebar sidebar-offcanvas">
        <ul class="nav nav-sidebar">
    <li class="nav-header">
      <a class="" href="#" data-toggle="collapse" data-target="#topicGroup0">
        <span id="tgSpan0" class="fa fa-angle-down"></span>Sync User Guide
      </a>
      <ul id="topicGroup0" class="collapse in list-unstyled">
            <li><a class="" href="../sync-dev/sync_overview.html">Overview</a></li>
            <li><a class="" href="../sync-dev/sync_terminology.html">Terminology</a></li>
            <li><a class="" href="../sync-dev/sync_server_architecture.html">Server architecture</a></li>
            <li><a class="" href="../sync-dev/sync_configuration_guide.html">Configuration guide</a></li>
            <li><a class="" href="../sync-dev/sync_upgrade_guide.html">Upgrade guide</a></li>
            <li><a class="" href="../sync-dev/sync_performance_scaling_guide.html">Performance guide</a></li>
            <li><a class="" href="../sync-dev/sync_collections.html">Collections</a></li>
            <li><a class=" active" href="../sync-dev/sync_debugging_guide.html">Debugging guide</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="#" data-toggle="collapse" data-target="#topicGroup1">
        <span id="tgSpan1" class="fa fa-angle-right"></span>Sync API Guide
      </a>
      <ul id="topicGroup1" class="collapse  list-unstyled">
            <li><a class="" href="../sync-ref/sync.html">sync</a></li>
            <li><a class="" href="../sync-ref/sync-connect.html">connect</a></li>
            <li><a class="" href="../sync-ref/sync-geteventemitter.html">geteventemitter</a></li>
            <li><a class="" href="../sync-ref/sync-globalhandlecollision.html">globalhandlecollision</a></li>
            <li><a class="" href="../sync-ref/sync-globalhandlecreate.html">globalhandlecreate</a></li>
            <li><a class="" href="../sync-ref/sync-globalhandledelete.html">globalhandledelete</a></li>
            <li><a class="" href="../sync-ref/sync-globalhandlelist.html">globalhandlelist</a></li>
            <li><a class="" href="../sync-ref/sync-globalhandleread.html">globalhandleread</a></li>
            <li><a class="" href="../sync-ref/sync-globalhandleupdate.html">globalhandleupdate</a></li>
            <li><a class="" href="../sync-ref/sync-globalinterceptrequest.html">globalinterceptrequest</a></li>
            <li><a class="" href="../sync-ref/sync-globallistcollisions.html">globallistcollisions</a></li>
            <li><a class="" href="../sync-ref/sync-globalremovecollision.html">globalremovecollision</a></li>
            <li><a class="" href="../sync-ref/sync-handlecollision.html">handlecollision</a></li>
            <li><a class="" href="../sync-ref/sync-handlecreate.html">handlecreate</a></li>
            <li><a class="" href="../sync-ref/sync-handledelete.html">handledelete</a></li>
            <li><a class="" href="../sync-ref/sync-handlelist.html">handlelist</a></li>
            <li><a class="" href="../sync-ref/sync-handleread.html">handleread</a></li>
            <li><a class="" href="../sync-ref/sync-handleupdate.html">handleupdate</a></li>
            <li><a class="" href="../sync-ref/sync-init.html">init</a></li>
            <li><a class="" href="../sync-ref/sync-interceptrequest.html">interceptrequest</a></li>
            <li><a class="" href="../sync-ref/sync-invoke.html">invoke</a></li>
            <li><a class="" href="../sync-ref/sync-listcollisions.html">listcollisions</a></li>
            <li><a class="" href="../sync-ref/sync-removecollision.html">removecollision</a></li>
            <li><a class="" href="../sync-ref/sync-setconfig.html">setconfig</a></li>
            <li><a class="" href="../sync-ref/sync-setglobalhashfn.html">setglobalhashfn</a></li>
            <li><a class="" href="../sync-ref/sync-setrecordhashfn.html">setrecordhashfn</a></li>
            <li><a class="" href="../sync-ref/sync-stop.html">stop</a></li>
            <li><a class="" href="../sync-ref/sync-stopall.html">stopall</a></li>
            <li><a class="" href="../sync-ref/sync-toc.html">toc</a></li>
      </ul>
    </li>
</ul>
      </div>
      <div class="col-xs-12 col-sm-9 col-md-9 main">
        <div class="page-header">
          <h2>Sync Server Debugging Guide</h2>
        </div>
        <div class="sect1">
<h2 id="client-changes-are-not-applied"><a class="anchor" href="#client-changes-are-not-applied"></a>Client Changes Are Not Applied</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To help debug this issue, answer the following questions:</p>
</div>
<div class="paragraph">
<p><strong>Has the client sent the change to the Server?</strong></p>
</div>
<div class="paragraph">
<p>Determine whether the change is sent by looking at the request body in sync requests after the client made the change.
The change should be in the <code>pending</code> array. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">{
  <span style="color:#606"><span style="color:#404">&quot;</span><span>fn</span><span style="color:#404">&quot;</span></span>:<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">sync</span><span style="color:#710">&quot;</span></span>,
  <span style="color:#606"><span style="color:#404">&quot;</span><span>dataset_id</span><span style="color:#404">&quot;</span></span>:<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">myShoppingList</span><span style="color:#710">&quot;</span></span>,
  <span style="color:#777">/*...*/</span>
  <span style="color:#606"><span style="color:#404">&quot;</span><span>pending</span><span style="color:#404">&quot;</span></span>:[{
    <span style="color:#606"><span style="color:#404">&quot;</span><span>inFlight</span><span style="color:#404">&quot;</span></span>:<span style="color:#069">true</span>,
    <span style="color:#606"><span style="color:#404">&quot;</span><span>action</span><span style="color:#404">&quot;</span></span>:<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">update</span><span style="color:#710">&quot;</span></span>,
    <span style="color:#606"><span style="color:#404">&quot;</span><span>post</span><span style="color:#404">&quot;</span></span>:{
      <span style="color:#606"><span style="color:#404">&quot;</span><span>name</span><span style="color:#404">&quot;</span></span>:<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Modified Name</span><span style="color:#710">&quot;</span></span>,
      <span style="color:#606"><span style="color:#404">&quot;</span><span>created</span><span style="color:#404">&quot;</span></span>:<span style="color:#00D">1495123790928</span>
    },
    <span style="color:#606"><span style="color:#404">&quot;</span><span>postHash</span><span style="color:#404">&quot;</span></span>:<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">2e90b858164184b9ff31e0937cef8ddf4a959ac5</span><span style="color:#710">&quot;</span></span>,
    <span style="color:#606"><span style="color:#404">&quot;</span><span>timestamp</span><span style="color:#404">&quot;</span></span>:<span style="color:#00D">1495799747404</span>,
    <span style="color:#606"><span style="color:#404">&quot;</span><span>uid</span><span style="color:#404">&quot;</span></span>:<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">591dc768a95300322eee1d1f</span><span style="color:#710">&quot;</span></span>,
    <span style="color:#606"><span style="color:#404">&quot;</span><span>pre</span><span style="color:#404">&quot;</span></span>:{
      <span style="color:#606"><span style="color:#404">&quot;</span><span>name</span><span style="color:#404">&quot;</span></span>:<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Original Name</span><span style="color:#710">&quot;</span></span>,
      <span style="color:#606"><span style="color:#404">&quot;</span><span>created</span><span style="color:#404">&quot;</span></span>:<span style="color:#00D">1495123790928</span>
    },
    <span style="color:#606"><span style="color:#404">&quot;</span><span>preHash</span><span style="color:#404">&quot;</span></span>:<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">421932b23f05f8aef528d73fff3cbf5aa00786a4</span><span style="color:#710">&quot;</span></span>,
    <span style="color:#606"><span style="color:#404">&quot;</span><span>hash</span><span style="color:#404">&quot;</span></span>:<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">f98f595974f7e7e1f07aed6220fab04446f459c9</span><span style="color:#710">&quot;</span></span>,
    <span style="color:#606"><span style="color:#404">&quot;</span><span>inFlightDate</span><span style="color:#404">&quot;</span></span>:<span style="color:#00D">1495799747850</span>
  }]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the change is not in the pending array, verify your device is online.
Check for any errors in the Client App and verify you are calling the relevant sync action, for example,  <code>sync.doUpdate()</code> for an update.
It may help to debug or add logging in the Client App around the code where you make the change.</p>
</div>
<div class="paragraph">
<p><strong>Is there a record for this change in the <code>fhsync_pending_queue</code> collection?</strong></p>
</div>
<div class="paragraph">
<p>If 'No', the change was not received by the server, or there was an error receiving it.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Verify the App successfully sent the change. If it did not, debug the App to understand the issue. There may be an error in the App, or an error in the response from the Server.</p>
</li>
<li>
<p>Check the server logs for errors when receiving the change from the App. If there are no errors, see <a href="#enabling-debug-logs">Enabling Debug Logs</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It is possible the record existed in the <code>fhsync_pending_queue</code> collection, but the Time To Live (TTL) period for queues has passed for the record, and it was removed.
If this is the case, increasing the TTL enables debugging.</p>
</div>
<div class="paragraph">
<p><strong>Does the record have a timestamp for the <code>deleted</code> field?</strong></p>
</div>
<div class="paragraph">
<p>If 'No', the item has not been processed yet</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Typically, the pending worker is busy processing items ahead of it in the queue. Wait until the item gets to the top of the queue for processing.</p>
</li>
<li>
<p>If an item is not processed after a significant time, or the queue is empty except for this item, check the server logs for any errors. If there are no errors, see <a href="#enabling-debug-logs">Enabling Debug Logs</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Is there a record for the update in the <code>fhsync_&lt;datasetid&gt;_updates</code> collection?</strong></p>
</div>
<div class="paragraph">
<p>If 'No',  the update may have encountered an error while processing.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Check the server logs for any errors. If there are no errors, see <a href="#enabling-debug-logs">Enabling Debug Logs</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Is the <code>type</code> field in the record set to <code>failed</code> or <code>collision</code>?</strong></p>
</div>
<div class="paragraph">
<p>If 'Yes', the update could not be applied to the Dataset back end.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A 'collision' should have resulted in the collision handler being called. The collision needs resolution.</p>
</li>
<li>
<p>A 'failed' update should have resulted in a notification on the client, with a reason for the failure. The reason is documented in the <code>msg</code> field of the record.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If 'No', and the type is <code>applied</code>, you need to debug the create or update handler to see why the handler assumed the change was applied to the Dataset back end.</p>
</div>
<div class="paragraph">
<p>The <code>type</code> field should never be anything other than <code>collision</code>, <code>failed</code> or <code>applied</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="changes-applied-to-the-dataset-back-end-do-not-propagate-to-other-clients"><a class="anchor" href="#changes-applied-to-the-dataset-back-end-do-not-propagate-to-other-clients"></a>Changes applied to the Dataset back end do not propagate to other Clients</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>Has sufficient time passed for the change to sync from the Dataset back end to clients?</strong></p>
</div>
<div class="paragraph">
<p>After a change has been applied to the Dataset back end, there are 2 things that need to happen before other clients get that change.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a sync loop on the server must complete to update the records cache, that is, the list handler is called for that dataset</p>
</li>
<li>
<p>a sync loop on the client(s) must complete for the client(s) local record cache to be updated from the servers record cache</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If sufficient time has passed, check the server logs for any errors during the sync with the Dataset back end.</p>
</div>
<div class="paragraph">
<p><strong>Is there a recent record in the <code>fhsync_queue</code> collection for the Dataset?</strong></p>
</div>
<div class="paragraph">
<p>If 'No', it is possible the TTL value for the record has passed and it was deleted.
In this case, the TTL value can be increased to enable further debugging.</p>
</div>
<div class="paragraph">
<p>Another possibility is the sync scheduler has not scheduled a sync for that Dataset.
The most likely reason is a combination of no currently active clients for that Dataset and the <code>clientSyncTimeout</code> has elapsed since the a client was last active for that Dataset.</p>
</div>
<div class="paragraph">
<p><strong>Does the record have a timestamp for the <code>deleted</code> field?</strong></p>
</div>
<div class="paragraph">
<p>If 'No', this means the sync is not processed yet.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Typically, the sync worker is busy processing items ahead of it in the queue. Wait until the item gets to the top of the queue.</p>
</li>
<li>
<p>If an item is not processed after a significant time, or the queue is empty except for this item, check the server logs for any errors. If there are no errors, see <a href="#enabling-debug-logs">Enabling Debug Logs</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Is the record in the <code>fhsync_&lt;datasetid&gt;_records</code> cache up to date?</strong></p>
</div>
<div class="paragraph">
<p>The list handler should have been called, and the result added to the records cache.
To verify the records cache is updated, check the <code>fhsync_&lt;datasetid&gt;_records</code> collection for the record that was updated.
The data in this record should match the data in the Dataset back end.
If it does not, check the server logs for errors and the behavior of the list handler.
It may help to add logging in your list handler.</p>
</div>
<div class="paragraph">
<p><strong>Is the client sync call successful?</strong></p>
</div>
<div class="paragraph">
<p>Check that there is a valid response from the server when the client makes its sync call.
If the call is successful, verify the client is getting the updated record(s).
If the updated records are not received by the client, even though the server cache has them, verify the query parameters and any meta data sent to the server are correct.
Enabling the Debug logs may help determine how the incorrect data is sent back to the client.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="enabling-debug-logs"><a class="anchor" href="#enabling-debug-logs"></a>Enabling Debug Logs</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To enable sync logs for debugging purposes, set the following environment variable in your server.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">DEBUG=fh-mbaas-api:sync</code></pre>
</div>
</div>
<div class="paragraph">
<p>This process generates a lot of logs.
Each log entry is tagged with a specific Dataset ID that is being actioned in the context of that log message, if possible.
These logs can be difficult to interpret, but allow you track updates from clients and the various stages for those updates.
It may help to compare logs for a successful scenario with an unsuccessful scenario, and identify which stage a failure occurs.</p>
</div>
<div class="paragraph">
<p>The most likely causes of issues are in custom handler implementations, particularly related to edge cases.
It can be useful to add additional logs in your custom handlers.</p>
</div>
<div class="paragraph">
<p>Dataset back end connectivity issues, particularly intermittent issues, can be difficult to debug and identify.
It can help to have external monitoring or checks on the Dataset back end.</p>
</div>
</div>
</div>
      </div>
    </div>
  </div>
   <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
   <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
   <!-- Latest compiled and minified JavaScript -->
   <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
   <script src="../../latest/_javascripts/bootstrap-offcanvas.js" type="text/javascript"></script>
   <script type="text/javascript">
    /*<![CDATA[*/
    $(document).ready(function() {
      $("[id^='topicGroup']").on('show.bs.collapse', function (event) {
        if (!($(event.target).attr('id').match(/^topicSubGroup/))) {
          $(this).parent().find("[id^='tgSpan']").toggleClass("fa-angle-right fa-angle-down");
        }
      });
      $("[id^='topicGroup']").on('hide.bs.collapse', function (event) {
        if (!($(event.target).attr('id').match(/^topicSubGroup/))) {
          $(this).parent().find("[id^='tgSpan']").toggleClass("fa-angle-right fa-angle-down");
        }
      });
      $("[id^='topicSubGroup']").on('show.bs.collapse', function () {
        $(this).parent().find("[id^='sgSpan']").toggleClass("fa-caret-right fa-caret-down");
      });
      $("[id^='topicSubGroup']").on('hide.bs.collapse', function () {
        $(this).parent().find("[id^='sgSpan']").toggleClass("fa-caret-right fa-caret-down");
      });
    });
    /*]]>*/
  </script>
</body>
</html>